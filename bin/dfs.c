#pragma config(Sensor, S1,     touchSensor,    sensorEV3_Touch)
#pragma config(Sensor, S2,     gyroSensor,     sensorEV3_Gyro)
#pragma config(Sensor, S3,     colorSensor,    sensorEV3_Color, modeEV3Color_Color)
#pragma config(Sensor, S4,     sonarSensor,    sensorEV3_Ultrasonic)
#pragma config(Motor,  motorA,          armMotor,      tmotorEV3_Large, PIDControl, encoder)
#pragma config(Motor,  motorB,          leftMotor,     tmotorEV3_Large, PIDControl, driveLeft, encoder)
#pragma config(Motor,  motorC,          rightMotor,    tmotorEV3_Large, PIDControl, driveRight, encoder)
//*!!Code automatically generated by 'ROBOTC' configuration wizard               !!*//

///////////////////////////////////////////////////////////////////
//                  Constants & Function                         //
///////////////////////////////////////////////////////////////////

//Constants
const int track_speed = 70;



//Functions

//Color Check
bool isSameColor(int color);
int lineTrack();
void turnL(int deg);
void turnR(int deg);

///////////////////////////////////////////////////////////////////
//                         Main Program                          //
///////////////////////////////////////////////////////////////////

task main()
{
	////////////////////
	// Init Variables //
	////////////////////
	bool finish = false;
	int block_found;


	//Start movement
	setMotor(leftMotor,50);
	setMotor(rightMotor,50);
	waitUntil(isSameColor(colorBlue));

	//Start tracking
	while(!finish){

		//Line tracking
		block_found = lineTrack();
		//Found Red
		if(block_found == 0){
			//Dead End, turn around
			setMotor(leftMotor,50);
			setMotor(rightMotor,50);
			waitUntil(!isSameColor(colorRed));
			stopAllMotors();
			turnL(180);
		}
		//Found Green
		else if(block_found == 2){
			//Start DFS
			//check left
			setMotor(leftMotor,50);
			setMotor(rightMotor,50);
			waitUntil(!isSameColor(colorGreen));
			stopAllMotors();
			turnL(90);

			//after turning checking (check for branch)
			if(getColorAmbient(colorSensor) >= 90){
				turnR(90);
			}
		}
		//Found Yellow
		else if(block_found == 1){
			setMotor(leftMotor,50);
			setMotor(rightMotor,50);
			waitUntil(!isSameColor(colorYellow));
			displayTextLine(5, "DONE!, backtracking");
			finish = true;
		}

	}
}


///////////////////////////////////////////////////////////////////
//                     Function Implementation                   //
///////////////////////////////////////////////////////////////////

bool isSameColor(int color){
	return (getColorName(colorSensor) == color);
}

// Melakukan tracking dan menghasilkan int dengan nilai tertentu
// jika menemukan warna berikut
// 0 = Red
// 1 = Yellow
// 2 = Green
int lineTrack(){
	int retval;
	bool exit = false;
	while (!exit){
		if(isSameColor(colorBlack) || isSameColor(colorBlue)){
			setMotor(rightMotor, 0);
			setMotor(leftMotor, track_speed);
		}
		else if(isSameColor(colorWhite)){
			setMotor(rightMotor, track_speed);
			setMotor(leftMotor, 0);
		}
		//Branch found
		else if(isSameColor(colorRed)){
			exit = true;
			stopAllMotors();
			retval = 0;
		}
		else if(isSameColor(colorYellow)){
			exit = true;
			stopAllMotors();
			retval = 1;
		}
		else if(isSameColor(colorGreen)){
			exit = true;
			stopAllMotors();
			retval = 2;
		}
	}
	return retval;
}

void turnR(int deg){
	string sOutputString;

	resetGyro(gyroSensor);
	setMotor(leftMotor,50);
	setMotor(rightMotor,-50);
	while(getGyroDegrees(gyroSensor) <= deg){
		//Output degrees of rotation to screen
		sprintf(sOutputString, "Gyro %d deg", getGyroDegrees(gyroSensor));
		displayTextLine(1, sOutputString);
	}
	stopAllMotors();
}

void turnL(int deg){
	string sOutputString;

	resetGyro(gyroSensor);
	setMotor(leftMotor,-50);
	setMotor(rightMotor,50);
	while(getGyroDegrees(gyroSensor) >= -deg){
		//Output degrees of rotation to screen
		sprintf(sOutputString, "Gyro rotation %d deg", getGyroDegrees(gyroSensor));
		displayTextLine(1, sOutputString);
	}
	stopAllMotors();
	}
